<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>交通信息 - 天气服务系统</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- 自定义样式 -->
    <link href="../css/style.css" rel="stylesheet" />
  </head>
  <body>
    <!-- 主内容 -->
    <div class="container main-container">
      <h2 class="mb-4"><i class="bi bi-airplane"></i> 交通信息</h2>

      <!-- 查询表单 -->
      <div class="card mb-4">
        <div class="card-header"><i class="bi bi-search"></i> 查询条件</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label">交通类型</label>
              <select class="form-select" id="trafficType">
                <option value="">全部</option>
                <option value="FLIGHT">航班</option>
                <option value="TRAIN">列车</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">城市</label>
              <input
                type="text"
                class="form-control"
                id="cityInput"
                placeholder="可选"
              />
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">开始日期</label>
              <input type="date" class="form-control" id="startDate" />
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">结束日期</label>
              <input type="date" class="form-control" id="endDate" />
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="searchTraffic()">
              <i class="bi bi-search"></i> 搜索
            </button>
            <button class="btn btn-outline-primary" onclick="loadFlights()">
              <i class="bi bi-airplane"></i> 查看航班
            </button>
            <button class="btn btn-outline-primary" onclick="loadTrains()">
              <i class="bi bi-train-front"></i> 查看列车
            </button>
          </div>
        </div>
      </div>

      <!-- 查询结果 -->
      <div id="trafficResult"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API 封装 -->
    <script src="../js/api.js"></script>
    <!-- 工具函数 -->
    <script src="../js/utils.js"></script>

    <script>
      // 搜索交通信息
      async function searchTraffic() {
        const type = document.getElementById("trafficType").value;
        const city = document.getElementById("cityInput").value;
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const resultDiv = document.getElementById("trafficResult");

        showLoading(resultDiv);

        try {
          const params = {};
          if (type) params.type = type;
          if (city) params.city = city;
          if (startDate) params.startDate = startDate;
          if (endDate) params.endDate = endDate;

          const data = await trafficApi.search(params);
          displayTrafficList(data);
        } catch (error) {
          showError(resultDiv, "查询失败，请检查网络连接或稍后重试");
        }
      }

      // 加载航班
      async function loadFlights() {
        const resultDiv = document.getElementById("trafficResult");
        showLoading(resultDiv);

        try {
          const data = await trafficApi.getFlights();
          displayTrafficList(data, "FLIGHT");
        } catch (error) {
          showError(resultDiv, "加载航班信息失败");
        }
      }

      // 加载列车
      async function loadTrains() {
        const resultDiv = document.getElementById("trafficResult");
        showLoading(resultDiv);

        try {
          const data = await trafficApi.getTrains();
          displayTrafficList(data, "TRAIN");
        } catch (error) {
          showError(resultDiv, "加载列车信息失败");
        }
      }

      // 显示交通列表
      function displayTrafficList(data, defaultType = "") {
        const resultDiv = document.getElementById("trafficResult");

        // 处理包装的响应格式 {data: {flights} 或 {trains} 或 {searchResults}, success: true}
        let items = [];
        if (data && data.data) {
          if (data.data.flights) {
            items = data.data.flights;
            defaultType = "FLIGHT";
          } else if (data.data.trains) {
            items = data.data.trains;
            defaultType = "TRAIN";
          } else if (data.data.searchResults) {
            items = data.data.searchResults;
          } else if (Array.isArray(data.data)) {
            items = data.data;
          }
        } else if (Array.isArray(data)) {
          items = data;
        }

        if (items.length === 0) {
          showEmpty(resultDiv, "暂无交通信息");
          return;
        }

        let html = `
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-ul"></i> 交通信息列表
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>类型</th>
                                        <th>班次/航班号</th>
                                        <th>出发城市</th>
                                        <th>到达城市</th>
                                        <th>计划时间</th>
                                        <th>预计时间</th>
                                        <th>状态</th>
                                        <th>原因</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

        items.forEach((item) => {
          const type = item.type || defaultType;
          const statusColor = getStatusColor(item.status);
          const statusText = getStatusText(item.status);

          html += `
                    <tr>
                        <td>${
                          type === "FLIGHT"
                            ? '<i class="bi bi-airplane"></i> 航班'
                            : '<i class="bi bi-train-front"></i> 列车'
                        }</td>
                        <td><strong>${item.number || "-"}</strong></td>
                        <td>${item.departureCity || "-"}</td>
                        <td>${item.arrivalCity || "-"}</td>
                        <td>${formatDate(item.scheduledTime) || "-"}</td>
                        <td>${formatDate(item.estimatedTime) || "-"}</td>
                        <td><span class="badge bg-${statusColor}">${statusText}</span></td>
                        <td>${item.delayReason || "-"}</td>
                    </tr>
                `;
        });

        html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

        resultDiv.innerHTML = html;
      }

      // 页面加载时默认加载所有交通信息
      window.addEventListener("DOMContentLoaded", function () {
        searchTraffic();
      });
    </script>
  </body>
</html>
