<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>管理后台 - 天气服务系统</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- 自定义样式 -->
    <link href="../../css/style.css" rel="stylesheet" />
    <link href="../../css/admin.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-2 admin-sidebar" id="sidebarContainer"></div>

        <!-- 主内容区 - 使用iframe -->
        <div class="col-md-10 admin-content">
          <iframe
            id="contentFrame"
            class="admin-iframe"
            src="dashboard.html"
          ></iframe>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API 封装 -->
    <script src="../../js/api.js"></script>
    <!-- 工具函数 -->
    <script src="../../js/utils.js"></script>
    <!-- 侧边栏组件 -->
    <script src="../../js/components/sidebar.js"></script>

    <script>
      let sidebar;
      let currentPage = "dashboard";

      // 检查登录状态
      async function checkAuth() {
        try {
          const response = await adminApi.getDashboard();
          if (!response || !response.success) {
            window.location.href = "login.html";
            return false;
          }
          return true;
        } catch (e) {
          window.location.href = "login.html";
          return false;
        }
      }

      // 导航到指定页面
      function navigateToPage(pageUrl, pageId) {
        const iframe = document.getElementById("contentFrame");
        if (iframe) {
          iframe.src = pageUrl;
          currentPage = pageId;
        }
      }

      // 初始化
      (async () => {
        const isAuth = await checkAuth();
        if (isAuth) {
          // 获取用户角色
          let userRole = "ADMIN"; // 默认管理员
          try {
            const dashboardResponse = await adminApi.getDashboard();
            if (
              dashboardResponse &&
              dashboardResponse.data &&
              dashboardResponse.data.userRole
            ) {
              userRole = dashboardResponse.data.userRole;
            }
          } catch (e) {
            console.warn("获取用户角色失败，使用默认值", e);
          }

          // 初始化侧边栏，传入用户角色
          sidebar = new AdminSidebar("sidebarContainer", navigateToPage);
          sidebar.setUserRole(userRole); // 设置用户角色
          sidebar.init(); // 重新初始化以应用角色过滤

          // 从URL参数获取初始页面
          const urlParams = new URLSearchParams(window.location.search);
          const page =
            urlParams.get("page") ||
            (userRole === "USER" ? "weather" : "dashboard");
          const pageMap = {
            dashboard: "dashboard.html",
            users: "users.html",
            weather: "weather.html",
            warnings: "warnings.html",
            traffic: "traffic.html",
            attractions: "attractions.html",
            logs: "logs.html",
          };

          if (pageMap[page]) {
            navigateToPage(pageMap[page], page);
            sidebar.setActive(page);
          }
        }
      })();
    </script>
  </body>
</html>
