<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>预警管理 - 天气服务系统</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- 自定义样式 -->
    <link href="../../css/style.css" rel="stylesheet" />
    <link href="../../css/admin.css" rel="stylesheet" />
  </head>
  <body>
    <div class="content-page">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-exclamation-triangle"></i> 预警管理</h2>
        <div>
          <button
            class="btn btn-warning me-2"
            data-bs-toggle="modal"
            data-bs-target="#simulateWarningModal"
          >
            <i class="bi bi-cloud-lightning"></i> 模拟天气预警发布
          </button>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#createWarningModal"
          >
            <i class="bi bi-plus-circle"></i> 创建综合预警
          </button>
        </div>
      </div>

      <!-- 标签页 -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#activeWarnings"
            >活跃预警</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#draftWarnings"
            >草稿预警</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#publishedWarnings"
            >已发布预警</a
          >
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="activeWarnings">
          <div class="card">
            <div class="card-body">
              <div id="activeWarningsContainer">
                <div class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="draftWarnings">
          <div class="card">
            <div class="card-body">
              <div id="draftWarningsContainer">
                <div class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="publishedWarnings">
          <div class="card">
            <div class="card-body">
              <div id="publishedWarningsContainer">
                <div class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 模拟天气预警发布模态框 -->
    <div class="modal fade" id="simulateWarningModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">模拟天气预警发布</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="simulateWarningForm">
              <div class="mb-3">
                <label class="form-label">地点代码</label>
                <input
                  type="text"
                  class="form-control"
                  id="simulateLocationCode"
                  placeholder="例如：SANYA"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">预警类型</label>
                <input
                  type="text"
                  class="form-control"
                  id="simulateWarningType"
                  placeholder="例如：大风、暴雨、台风等"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">预警级别</label>
                <select class="form-select" id="simulateWarningLevel" required>
                  <option value="红色">红色</option>
                  <option value="橙色">橙色</option>
                  <option value="黄色">黄色</option>
                  <option value="蓝色">蓝色</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">标题</label>
                <input
                  type="text"
                  class="form-control"
                  id="simulateTitle"
                  placeholder="例如：三亚市气象台发布大风蓝色预警信号"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">内容</label>
                <textarea
                  class="form-control"
                  id="simulateContent"
                  rows="4"
                  placeholder="预警详细内容..."
                  required
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">生效时间</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="simulateEffectiveTime"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">过期时间</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="simulateExpireTime"
                    required
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-warning"
              id="submitSimulateBtn"
            >
              发布模拟预警
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 创建预警模态框 -->
    <div class="modal fade" id="createWarningModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">创建综合预警</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createWarningForm">
              <div class="mb-3">
                <label class="form-label">标题</label>
                <input
                  type="text"
                  class="form-control"
                  id="warningTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">内容</label>
                <textarea
                  class="form-control"
                  id="warningContent"
                  rows="4"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">预警级别</label>
                <select class="form-select" id="warningLevel" required>
                  <option value="红色">红色</option>
                  <option value="橙色">橙色</option>
                  <option value="黄色">黄色</option>
                  <option value="蓝色">蓝色</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">受影响地区（用逗号分隔）</label>
                <input
                  type="text"
                  class="form-control"
                  id="affectedLocations"
                  placeholder="例如：海口,三亚,儋州"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">交通影响</label>
                <textarea
                  class="form-control"
                  id="trafficEffects"
                  rows="2"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">景点影响</label>
                <textarea
                  class="form-control"
                  id="attractionEffects"
                  rows="2"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button type="button" class="btn btn-primary" id="submitWarningBtn">
              创建
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API 封装 -->
    <script src="../../js/api.js"></script>
    <!-- 工具函数 -->
    <script src="../../js/utils.js"></script>

    <script>
      let activeWarnings = [];
      let draftWarnings = [];
      let publishedWarnings = [];

      // 检查登录状态
      async function checkAuth() {
        try {
          const response = await adminApi.getDashboard();
          if (!response || !response.success) {
            window.location.href = "login.html";
            return false;
          }
          return true;
        } catch (e) {
          window.location.href = "login.html";
          return false;
        }
      }

      // 加载预警数据
      async function loadWarnings() {
        try {
          const response = await adminApi.getWarnings();
          if (response && response.success && response.data) {
            activeWarnings = response.data.allWarnings || [];
            draftWarnings = response.data.draftWarnings || [];
            publishedWarnings = response.data.publishedWarnings || [];

            displayActiveWarnings(activeWarnings);
            displayDraftWarnings(draftWarnings);
            displayPublishedWarnings(publishedWarnings);
          } else {
            showError(
              document.getElementById("activeWarningsContainer"),
              "加载预警数据失败"
            );
          }
        } catch (error) {
          console.error("加载预警数据失败:", error);
          showError(
            document.getElementById("activeWarningsContainer"),
            "加载预警数据失败"
          );
        }
      }

      // 显示活跃预警
      function displayActiveWarnings(warnings) {
        const container = document.getElementById("activeWarningsContainer");
        if (!warnings || warnings.length === 0) {
          showEmpty(container, "暂无活跃预警");
          return;
        }

        let html = '<table class="table table-hover">';
        html +=
          "<thead><tr><th>地点</th><th>类型</th><th>级别</th><th>标题</th><th>发布时间</th><th>状态</th></tr></thead>";
        html += "<tbody>";

        warnings.forEach((warning) => {
          const levelColor = getWarningLevelColor(warning.warningLevel);
          html += `<tr>
                    <td>${getCityName(warning.locationCode)}</td>
                    <td>${warning.warningType || "-"}</td>
                    <td><span class="badge bg-${levelColor}">${
            warning.warningLevel
          }</span></td>
                    <td>${warning.title || "-"}</td>
                    <td>${formatDate(warning.issueTime)}</td>
                    <td><span class="badge bg-success">${getStatusText(
                      warning.status
                    )}</span></td>
                </tr>`;
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // 显示草稿预警
      function displayDraftWarnings(warnings) {
        const container = document.getElementById("draftWarningsContainer");
        if (!warnings || warnings.length === 0) {
          showEmpty(container, "暂无草稿预警");
          return;
        }

        let html = '<table class="table table-hover">';
        html +=
          "<thead><tr><th>标题</th><th>级别</th><th>创建时间</th><th>操作</th></tr></thead>";
        html += "<tbody>";

        warnings.forEach((warning) => {
          const levelColor = getWarningLevelColor(warning.warningLevel);
          html += `<tr>
                    <td>${warning.title || "-"}</td>
                    <td><span class="badge bg-${levelColor}">${
            warning.warningLevel
          }</span></td>
                    <td>${formatDate(warning.createdTime)}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="publishWarning(${
                          warning.id
                        })">
                            <i class="bi bi-send"></i> 发布
                        </button>
                    </td>
                </tr>`;
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // 显示已发布预警
      function displayPublishedWarnings(warnings) {
        const container = document.getElementById("publishedWarningsContainer");
        if (!warnings || warnings.length === 0) {
          showEmpty(container, "暂无已发布预警");
          return;
        }

        let html = '<table class="table table-hover">';
        html +=
          "<thead><tr><th>标题</th><th>级别</th><th>发布时间</th><th>受影响地区</th><th>操作</th></tr></thead>";
        html += "<tbody>";

        warnings.forEach((warning) => {
          const levelColor = getWarningLevelColor(warning.warningLevel);
          html += `<tr>
                    <td>${warning.title || "-"}</td>
                    <td><span class="badge bg-${levelColor}">${
            warning.warningLevel
          }</span></td>
                    <td>${formatDate(warning.publishTime)}</td>
                    <td>${warning.affectedLocations || "-"}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="invalidateWarning(${
                          warning.id
                        })">
                            <i class="bi bi-x-circle"></i> 立即失效
                        </button>
                    </td>
                </tr>`;
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // 立即失效预警
      async function invalidateWarning(warningId) {
        if (!confirm("确定要让此预警立即失效吗？")) {
          return;
        }

        try {
          const response = await adminApi.invalidateWarning(warningId);
          if (response && response.success) {
            showSuccess("预警已失效");
            loadWarnings();
          } else {
            alert("失效失败：" + (response.message || "未知错误"));
          }
        } catch (error) {
          console.error("失效预警失败:", error);
          alert("失效失败，请稍后重试");
        }
      }

      // 发布预警
      async function publishWarning(warningId) {
        if (!confirm("确定要发布此预警吗？")) {
          return;
        }

        try {
          const response = await adminApi.publishWarning(warningId);
          if (response && response.success) {
            showSuccess("预警发布成功");
            loadWarnings();
          } else {
            alert("发布失败：" + (response.message || "未知错误"));
          }
        } catch (error) {
          console.error("发布预警失败:", error);
          alert("发布失败，请稍后重试");
        }
      }

      // 创建预警
      document
        .getElementById("submitWarningBtn")
        .addEventListener("click", async () => {
          const title = document.getElementById("warningTitle").value;
          const content = document.getElementById("warningContent").value;
          const warningLevel = document.getElementById("warningLevel").value;
          const affectedLocations = document
            .getElementById("affectedLocations")
            .value.split(",")
            .map((s) => s.trim())
            .filter((s) => s);
          const trafficEffects =
            document.getElementById("trafficEffects").value;
          const attractionEffects =
            document.getElementById("attractionEffects").value;

          if (!title || !content) {
            alert("请填写标题和内容");
            return;
          }

          try {
            const warningData = {
              title,
              content,
              warningLevel,
              affectedLocations,
              weatherWarningIds: [],
              trafficEffects,
              attractionEffects,
            };

            const response = await adminApi.createWarning(warningData);
            if (response && response.success) {
              showSuccess("预警创建成功");
              bootstrap.Modal.getInstance(
                document.getElementById("createWarningModal")
              ).hide();
              document.getElementById("createWarningForm").reset();
              loadWarnings();
            } else {
              alert("创建失败：" + (response.message || "未知错误"));
            }
          } catch (error) {
            console.error("创建预警失败:", error);
            alert("创建失败，请稍后重试");
          }
        });

      // 提交模拟预警
      document
        .getElementById("submitSimulateBtn")
        .addEventListener("click", async () => {
          const locationCode = document.getElementById(
            "simulateLocationCode"
          ).value;
          const warningType = document.getElementById(
            "simulateWarningType"
          ).value;
          const warningLevel = document.getElementById(
            "simulateWarningLevel"
          ).value;
          const title = document.getElementById("simulateTitle").value;
          const content = document.getElementById("simulateContent").value;
          const effectiveTime = document.getElementById(
            "simulateEffectiveTime"
          ).value;
          const expireTime =
            document.getElementById("simulateExpireTime").value;

          if (
            !locationCode ||
            !warningType ||
            !title ||
            !content ||
            !effectiveTime ||
            !expireTime
          ) {
            alert("请填写所有必填项");
            return;
          }

          try {
            const warningData = {
              locationCode,
              warningType,
              warningLevel,
              title,
              content,
              effectiveTime,
              expireTime,
            };

            const response = await adminApi.simulateWeatherWarning(warningData);
            if (response && response.success) {
              showSuccess("模拟预警发布成功");
              bootstrap.Modal.getInstance(
                document.getElementById("simulateWarningModal")
              ).hide();
              document.getElementById("simulateWarningForm").reset();
              loadWarnings();
            } else {
              alert("发布失败：" + (response.message || "未知错误"));
            }
          } catch (error) {
            console.error("发布模拟预警失败:", error);
            alert("发布失败，请稍后重试");
          }
        });

      // 页面加载
      (async () => {
        const isAuth = await checkAuth();
        if (isAuth) {
          loadWarnings();
        }
      })();
    </script>
  </body>
</html>
