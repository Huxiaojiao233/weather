<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>景点信息 - 天气服务系统</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- 自定义样式 -->
    <link href="../css/style.css" rel="stylesheet" />
  </head>
  <body>
    <!-- 主内容 -->
    <div class="container main-container">
      <h2 class="mb-4"><i class="bi bi-geo-alt"></i> 景点信息</h2>

      <!-- 查询表单 -->
      <div class="card mb-4">
        <div class="card-header"><i class="bi bi-search"></i> 查询条件</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">景点名称</label>
              <input
                type="text"
                class="form-control"
                id="nameInput"
                placeholder="输入景点名称"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">状态</label>
              <select class="form-select" id="statusSelect">
                <option value="">全部状态</option>
                <option value="OPEN">开放</option>
                <option value="CLOSED">关闭</option>
                <option value="LIMITED">限时开放</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">城市</label>
              <select class="form-select" id="locationSelect">
                <option value="">全部城市</option>
                <option value="SANYA">三亚</option>
                <option value="HAIKOU">海口</option>
                <option value="DANZHOU">儋州</option>
                <option value="SANSA">三沙</option>
                <option value="QIONGHAI">琼海</option>
                <option value="WANNING">万宁</option>
                <option value="DONGFANG">东方</option>
                <option value="WUZHISHAN">五指山</option>
                <option value="CHENGMAI">澄迈</option>
                <option value="LINGAO">临高</option>
              </select>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="searchAttractions()">
              <i class="bi bi-search"></i> 搜索
            </button>
            <button
              class="btn btn-outline-primary"
              onclick="loadAllAttractions()"
            >
              <i class="bi bi-list-ul"></i> 查看全部
            </button>
          </div>
        </div>
      </div>

      <!-- 查询结果 -->
      <div id="attractionsResult"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API 封装 -->
    <script src="../js/api.js"></script>
    <!-- 工具函数 -->
    <script src="../js/utils.js"></script>

    <script>
      // 搜索景点
      async function searchAttractions() {
        const name = document.getElementById("nameInput").value;
        const status = document.getElementById("statusSelect").value;
        const location = document.getElementById("locationSelect").value;
        const resultDiv = document.getElementById("attractionsResult");

        showLoading(resultDiv);

        try {
          let response;
          if (location) {
            response = await attractionApi.getByLocation(location);
          } else {
            const params = {};
            if (name) params.name = name;
            if (status) params.status = status;
            response = await attractionApi.search(params);
          }
          displayAttractions(response);
        } catch (error) {
          console.error("查询景点失败:", error);
          showError(resultDiv, "查询失败，请检查网络连接或稍后重试");
        }
      }

      // 加载所有景点
      async function loadAllAttractions() {
        const resultDiv = document.getElementById("attractionsResult");
        showLoading(resultDiv);

        try {
          const response = await attractionApi.getStatus();
          displayAttractions(response);
        } catch (error) {
          console.error("加载景点信息失败:", error);
          showError(resultDiv, "加载景点信息失败");
        }
      }

      // 加载今日开放景点
      async function loadOpenToday() {
        const resultDiv = document.getElementById("attractionsResult");
        showLoading(resultDiv);

        try {
          const response = await attractionApi.getOpenToday();
          displayAttractions(response);
        } catch (error) {
          console.error("加载今日开放景点失败:", error);
          showError(resultDiv, "加载今日开放景点失败");
        }
      }

      // 显示景点列表
      function displayAttractions(data) {
        const resultDiv = document.getElementById("attractionsResult");

        // data 已经是后端返回的完整响应 {success: true, data: {...}}
        // 需要从 data.data 中提取景点数组
        let attractions = [];

        // 检查响应是否成功
        if (!data) {
          showError(resultDiv, "获取景点信息失败：响应为空");
          return;
        }

        if (!data.success) {
          showError(resultDiv, data.message || "获取景点信息失败");
          return;
        }

        // 从 data.data 中提取景点数组
        if (data.data) {
          if (
            data.data.allAttractions &&
            Array.isArray(data.data.allAttractions)
          ) {
            attractions = data.data.allAttractions;
          } else if (
            data.data.attractions &&
            Array.isArray(data.data.attractions)
          ) {
            attractions = data.data.attractions;
          } else if (
            data.data.searchResults &&
            Array.isArray(data.data.searchResults)
          ) {
            attractions = data.data.searchResults;
          } else if (
            data.data.nowOpenAttractions &&
            Array.isArray(data.data.nowOpenAttractions)
          ) {
            attractions = data.data.nowOpenAttractions;
          } else if (Array.isArray(data.data)) {
            attractions = data.data;
          }
        } else if (Array.isArray(data)) {
          attractions = data;
        }

        console.log("提取的景点数据:", attractions);

        if (!attractions || attractions.length === 0) {
          showEmpty(resultDiv, "暂无景点信息");
          return;
        }

        let html = '<div class="row">';
        attractions.forEach((attraction) => {
          const statusColor = getStatusColor(attraction.openStatus);
          const statusText = getStatusText(attraction.openStatus);

          html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">${attraction.name || "-"}</h5>
                            </div>
                            <div class="card-body">
                                <p><i class="bi bi-geo-alt"></i> ${
                                  attraction.address || "-"
                                }</p>
                                <p><i class="bi bi-building-fill"></i> ${
                                  getCityName(attraction.locationCode) || "-"
                                }</p>
                                <p>
                                    <span class="badge bg-${statusColor}">${statusText}</span>
                                    ${
                                      attraction.closeReason
                                        ? `<span class="text-muted"> - ${attraction.closeReason}</span>`
                                        : ""
                                    }
                                </p>
                                ${
                                  attraction.openTime && attraction.closeTime
                                    ? `<p><i class="bi bi-clock"></i> 开放时间: ${formatTime(
                                        attraction.openTime
                                      )} - ${formatTime(
                                        attraction.closeTime
                                      )}</p>`
                                    : ""
                                }
                                <button class="btn btn-sm btn-outline-primary" onclick="viewAttractionDetail('${
                                  attraction.name
                                }')">
                                    <i class="bi bi-info-circle"></i> 查看详情
                                </button>
                            </div>
                        </div>
                    </div>
                `;
        });
        html += "</div>";

        resultDiv.innerHTML = html;
      }

      // 查看景点详情
      async function viewAttractionDetail(name) {
        try {
          const response = await attractionApi.getDetail(name);
          // 处理包装的响应格式 {data: {attraction}, success: true}
          const attraction =
            response && response.data ? response.data.attraction : null;
          if (attraction) {
            alert(
              `景点详情：\n名称：${attraction.name || "-"}\n地址：${
                attraction.address || "-"
              }\n状态：${getStatusText(attraction.openStatus)}\n${
                attraction.closeReason
                  ? "关闭原因：" + attraction.closeReason
                  : ""
              }`
            );
          } else {
            alert("未找到景点详情");
          }
        } catch (error) {
          alert("获取景点详情失败");
        }
      }

      // 页面加载时默认加载所有景点
      window.addEventListener("DOMContentLoaded", function () {
        loadAllAttractions();
      });
    </script>
  </body>
</html>
