<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>管理员仪表盘 - 天气服务系统</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- 自定义样式 -->
    <link href="../../css/style.css" rel="stylesheet" />
    <link href="../../css/admin.css" rel="stylesheet" />
    <style>
      .stat-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
      }
      .stat-card.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .stat-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }
      .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .stat-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
    </style>
  </head>
  <body>
    <div class="content-page">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-speedometer2"></i> 仪表盘</h2>
            <span id="currentUser" class="text-muted"></span>
          </div>

          <!-- 统计卡片 -->
          <div class="row" id="statsContainer">
            <div class="col-md-3">
              <div class="stat-card primary">
                <h5><i class="bi bi-exclamation-triangle"></i> 活跃预警</h5>
                <h2 id="activeWarningCount">-</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card success">
                <h5><i class="bi bi-broadcast"></i> 已发布预警</h5>
                <h2 id="publishedWarningCount">-</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card warning">
                <h5><i class="bi bi-airplane"></i> 异常航班</h5>
                <h2 id="abnormalFlightCount">-</h2>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card info">
                <h5><i class="bi bi-geo-alt"></i> 关闭景点</h5>
                <h2 id="closedAttractionCount">-</h2>
              </div>
            </div>
          </div>

          <!-- 最近操作日志 -->
          <div class="card mt-4">
            <div class="card-header">
              <h5><i class="bi bi-journal-text"></i> 最近操作日志</h5>
            </div>
            <div class="card-body">
              <div id="recentLogsContainer">
                <div class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API 封装 -->
    <script src="../../js/api.js"></script>
    <!-- 工具函数 -->
    <script src="../../js/utils.js"></script>

    <script>
      // 检查登录状态
      async function checkAuth() {
        try {
          const response = await adminApi.getDashboard();
          if (!response || !response.success) {
            // 如果在iframe中，通知父窗口跳转
            if (window.parent !== window) {
              window.parent.location.href = "login.html";
            } else {
              window.location.href = "login.html";
            }
            return false;
          }
          return true;
        } catch (e) {
          // 如果在iframe中，通知父窗口跳转
          if (window.parent !== window) {
            window.parent.location.href = "login.html";
          } else {
            window.location.href = "login.html";
          }
          return false;
        }
      }

      // 加载仪表盘数据
      async function loadDashboard() {
        try {
          const response = await adminApi.getDashboard();
          if (response && response.success && response.data) {
            const data = response.data;

            // 更新统计数据
            document.getElementById("activeWarningCount").textContent =
              data.activeWarningCount || 0;
            document.getElementById("publishedWarningCount").textContent =
              data.publishedWarningCount || 0;
            document.getElementById("abnormalFlightCount").textContent =
              data.abnormalFlightCount || 0;
            document.getElementById("closedAttractionCount").textContent =
              data.closedAttractionCount || 0;

            // 显示最近日志
            displayRecentLogs(data.recentLogs || []);
          }
        } catch (error) {
          console.error("加载仪表盘数据失败:", error);
          showError(
            document.getElementById("recentLogsContainer"),
            "加载数据失败"
          );
        }
      }

      // 显示最近日志
      function displayRecentLogs(logs) {
        const container = document.getElementById("recentLogsContainer");
        if (!logs || logs.length === 0) {
          showEmpty(container, "暂无操作日志");
          return;
        }

        let html = '<table class="table table-hover">';
        html +=
          "<thead><tr><th>时间</th><th>操作</th><th>模块</th><th>描述</th><th>IP地址</th></tr></thead>";
        html += "<tbody>";

        logs.forEach((log) => {
          html += `<tr>
                    <td>${formatDate(log.operationTime)}</td>
                    <td>${log.operation || "-"}</td>
                    <td>${log.module || "-"}</td>
                    <td>${log.description || "-"}</td>
                    <td>${log.ipAddress || "-"}</td>
                </tr>`;
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // 页面加载
      (async () => {
        const isAuth = await checkAuth();
        if (isAuth) {
          loadDashboard();
        }
      })();
    </script>
  </body>
</html>
